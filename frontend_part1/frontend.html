<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Task 1 ‚Äì Add & Sign Inventory Record</title>
  <style>
    body{font-family:Arial;padding:2rem;background:#e8e8e8}
    label,select,input,button{display:block;margin:0.5rem 0;font-size:1rem}
    pre{background:#eee;padding:1rem;border-radius:4px;white-space:pre-wrap}
    .invalid{color:red} .valid{color:green}
    .badge{font-size:1.1rem;padding:0.5rem;background:#d4edda;color:#155724;
           border:1px solid #c3e6cb;border-radius:4px;display:inline-block}
  </style>
</head>
<body>
  <h1>üì¶ Task 1 ‚Äì Add New Inventory Record</h1>
  <label>Select Inventory Node:</label>
<select id="node">
  <option></option>
  <option>NodeA</option>
  <option>NodeB</option>
  <option>NodeC</option>
  <option>NodeD</option>
</select>


  <label>Item ID:</label>
  <input id="itemId" placeholder="e.g. 001">

  <label>Quantity:</label>
  <input id="qty" type="number" placeholder="e.g. 32">

  <label>Price:</label>
  <input id="price" type="number" step="0.01" placeholder="e.g. 12.00">

  <button onclick="addRecord()">Sign & Submit</button>

  <h3>Response:</h3>
  <pre id="output">‚Äî</pre>

<script>
  async function addRecord() {
    const node  = document.getElementById('node').value;
    const validators = ["NodeA", "NodeB", "NodeC", "NodeD"];
    const verifiers = validators.filter(n => n !== node);
    const id    = document.getElementById('itemId').value;
    const qty   = Number(document.getElementById('qty').value);
    const price = Number(document.getElementById('price').value);
    const out   = document.getElementById('output');

    if (!node || !id || !qty || isNaN(price)) {
      out.innerHTML = '<span class="invalid">Please fill in all fields.</span>';
      return;
    }
    out.textContent = 'Signing‚Ä¶';

    try {
      const res = await fetch('http://localhost:5000/add_record', {
        method:  'POST',
        headers: {'Content-Type':'application/json'},
        body:    JSON.stringify({ node, record:{ id, qty, price } })
      });
      const data = await res.json();
      if (!res.ok) {
        out.innerHTML = `<span class="invalid">Error: ${data.error}</span>`;
        return;
      }

      let peerDetails = Object.entries(data.details).map(([peer, d]) => {
        let decryptedHex = d.decrypted_signature
          ? BigInt(d.decrypted_signature).toString(16)
          : 'Signer no need for verification';
        let hashHex = d.expected_hash
          ? BigInt(d.expected_hash).toString(16)
          : 'Signer no need for verification';

        return `
          <tr>
            <td>${peer}</td>
            <td>${decryptedHex}</td>
            <td>${hashHex}</td>
            <td>${d.matched === null ? '‚Äî' : d.matched ? 'Yes' : 'No'}</td>
          </tr>
        `;
      }).join('');

      out.innerHTML = `
<div class="badge"> Consensus reached!</div>
<b>Node:</b> ${data.node}<br>
<b>Signer:</b> ${data.node}<br>
<b>Verifying Nodes:</b> ${["NodeA", "NodeB", "NodeC", "NodeD"].filter(n => n !== data.node).join(", ")}<br>
<b>Item ID:</b> ${data.record.id}<br>
<b>Quantity:</b> ${data.record.qty}<br>
<b>Price:</b> $${data.record.price}<br>

<hr>
<b>p:</b> ${data.p}<br>
<b>q:</b> ${data.q}<br>
<b>œÜ(n):</b> ${data.phi}<br>
<b>n:</b> ${data.modulus_n}<br>
<b>e:</b> ${data.public_e}<br>
<b>d:</b> ${data.private_d}<br>
<b>SHA-256 Hash:</b> ${data.hash_int}<br>
<b>Signature:</b> ${data.signature}<br>

<hr>
<b>Formulas:</b><br>
œÜ(n) = (p - 1) √ó (q - 1) = (${data.p} - 1) √ó (${data.q} - 1) = ${data.phi}<br>
d = e‚Åª¬π mod œÜ(n) = ${data.public_e}‚Åª¬π mod ${data.phi} = ${data.private_d}<br>
n = p √ó q = ${data.p} √ó ${data.q} = ${data.modulus_n}<br><br>

<b>Signature Verification:</b><br>
signature^e mod n == hash<br>
${data.signature}^${data.public_e} mod ${data.modulus_n} = ${data.hash_int}<br>

<b>Signer:</b> NodeB<br>
<b>Verifying Nodes:</b> NodeA, NodeC, NodeD<br>


<hr>
<table border="1" cellpadding="5">
  <thead><tr><th>Peer</th><th>Decrypted Hash (hex)</th><th>Original Hash (hex)</th><th>Match</th></tr></thead>
  <tbody>
    ${peerDetails}
  </tbody>
</table>
      `;

    } catch (err) {
      out.innerHTML = `<span class="invalid">Fetch error: ${err.message}</span>`;
    }
  }
</script>


</body>
</html>