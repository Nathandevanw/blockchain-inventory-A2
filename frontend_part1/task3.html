<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Task 3 ‚Äì PBFT Inventory Query</title>
  <style>
    body { font-family: Arial; padding: 2rem; background: #f4f4f4; }
    label, input, button { display: block; margin: 0.5rem 0; font-size: 1rem; }
    pre { background: #fff; padding: 1rem; border-radius: 4px; white-space: pre-wrap; }
    .badge { background: #d4edda; color: #155724; padding: 0.5rem; border-radius: 4px;
             border: 1px solid #c3e6cb; font-size: 1rem; margin-top: 1rem; }
    .invalid { color: red; }
    .details { margin-top: 1rem; border: 1px solid #ccc; padding: 1rem; background: #fff; border-radius: 6px; }
    .details h4 { margin: 0 0 0.5rem 0; }
  </style>
</head>
<body>

  <h1>üîê Task 3 ‚Äì Query & Verify Inventory (PBFT + Signature)</h1>

  <label for="itemId">Enter Item ID:</label>
  <input id="itemId" placeholder="e.g. 001">
  <button onclick="queryRecord()">Submit</button>

  <h3>Response:</h3>
  <pre id="output">‚Äî</pre>
  <div id="details"></div>

  <script>
    async function queryRecord() {
      const id = document.getElementById('itemId').value.trim();
      const out = document.getElementById('output');
      const detailsDiv = document.getElementById('details');

      if (!id) {
        out.innerHTML = '<span class="invalid">Please enter an Item ID.</span>';
        detailsDiv.innerHTML = '';
        return;
      }

      out.textContent = '‚è≥ Querying record...';
      detailsDiv.innerHTML = '';

      try {
        const res = await fetch('http://localhost:5000/query_item', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ item_id: id })
        });

        const text = await res.text();
        let data;

        try {
          data = JSON.parse(text);
        } catch {
          throw new Error("Server returned invalid JSON:\n" + text);
        }

        if (!res.ok) {
          out.innerHTML = `<span class="invalid">‚ùå Error: ${data.error || "Unknown issue"}</span>`;
          return;
        }

        out.innerHTML = `
<div class="badge">‚úÖ PBFT Consensus: ${data.pbft_votes.consensus ? "Yes" : "No"}</div>

Item ID:            ${data.item.id}
Quantity:           ${data.item.qty}
Price:              $${data.item.price}

Encrypted Quantity: ${data.encrypted_quantity}
Decrypted Quantity: ${data.decrypted_quantity}

Signature Valid:    ${data.signature_valid ? "‚úÖ Valid" : "‚ùå Invalid"}
Final Signature (s): ${data.multi_signature}
Hash (h):            ${data.h}
LHS:                 ${data.lhs}
RHS:                 ${data.rhs}
        `.trim();

        let detailsHTML = `<h3>üßæ Warehouse Signature Components</h3>`;
        data.warehouse_details.forEach(w => {
          detailsHTML += `
<div class="details">
  <h4>üè∑Ô∏è ${w.warehouse}</h4>
  ID (g):     ${w.g}<br>
  t<sub>i</sub>:     ${w.t_i}<br>
  s<sub>i</sub>:     ${w.s_i}
</div>
          `;
        });
        detailsDiv.innerHTML = detailsHTML;

      } catch (err) {
        out.innerHTML = `<span class="invalid">‚ùå Fetch error: ${err.message}</span>`;
        detailsDiv.innerHTML = '';
      }
    }
  </script>

</body>
</html>
