<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>DLT Inventory Query - Task 3</title>
  <style>
    body { font-family: 'Segoe UI', sans-serif; padding: 2rem; background: #f8f8f8; color: #333; }
    h2, h3 { color: #222; }
    label, select, button { display: block; margin-top: 1rem; font-size: 1rem; }
    table { margin-top: 1.5rem; border-collapse: collapse; width: 100%; font-size: 0.95rem; }
    th, td { padding: 8px; border: 1px solid #ccc; text-align: center; }
    th { background-color: #f0f0f0; }
    pre { background: #eee; padding: 1rem; border-radius: 6px; white-space: pre-wrap; font-size: 0.85rem; }
  </style>
</head>
<body>
  <h2>Task 3 - Secure DLT Inventory Query System</h2>

  <label for="itemId">Select Item ID:</label>
  <select id="itemId">
    <option value="001">Item 001</option>
    <option value="002">Item 002</option>
    <option value="003">Item 003</option>
    <option value="004">Item 004</option>
  </select>
  <button onclick="queryItem()">Submit Query</button>

  <div id="output" style="margin-top:2rem;"></div>

  <script>

    window.addEventListener("beforeunload", function() {
    localStorage.setItem("lastOutput", document.getElementById("output").innerHTML);
    });
    window.addEventListener("load", function() {
    if (localStorage.getItem("lastOutput")) {
        document.getElementById("output").innerHTML = localStorage.getItem("lastOutput");
      }
    });

    async function queryItem() {
      const itemId = document.getElementById('itemId').value;
      const output = document.getElementById('output');
      output.innerHTML = 'Please wait...';

      try {
        const res = await fetch('http://localhost:5000/query_item', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ item_id: itemId })
        });
        const data = await res.json();
        if (data.error) { output.innerHTML = `<p style="color:red">${data.error}</p>`; return; }

        let html = `<h3>Step 1: PKG Key Setup</h3>
<p>PKG calculates its key pair (public & private keys).</p>
<pre>
n = p × q = ${BigInt(data.n).toString()}
phi(n) = (p - 1)(q - 1) = ${BigInt(data.phi_n).toString()}
d = e⁻¹ mod phi(n) = ${BigInt(data.d).toString()}
PKG Public Key = (e,n) = (${BigInt(data.e).toString()}, ${BigInt(data.n).toString()})
PKG Private Key = (d,n) = (${BigInt(data.d).toString()}, ${BigInt(data.n).toString()})
</pre>`;

        html += `<h3>Step 2: Item Found</h3>
<p>PKG receives item query and finds the item in warehouse database.</p>
<pre>
Item ID: ${data.itemId}
Quantity: ${data.item.qty}
Price: ${data.item.price}
Location: ${data.item.location}
</pre>`;

        html += `<h3>Step 3: Warehouse Signature Setup</h3>
<p>Warehouses send IDs to PKG; PKG calculates g = ID^d mod n.</p>`;
        data.warehouses.forEach(w => {
          html += `
<pre>
Warehouse: ${w.warehouse}
ID = ${w.ID}
Random r = ${w.random}
g = ID^d mod n = ${BigInt(w.g).toString()}
</pre>`;
        });

        html += `<h3>Step 4: Warehouses Generate tᵢ Values</h3>
<p>Each warehouse calculates tᵢ = r^e mod n.</p>`;
        data.warehouses.forEach(w => {
          html += `
<pre>
Warehouse: ${w.warehouse}
tᵢ = ${BigInt(w.t_i).toString()}
</pre>`;
        });

        html += `<h3>Step 5: PKG Calculates Hash</h3>
<p>PKG computes h = MD5(t_total || qty).</p>
<pre>
t_total = ${BigInt(data.t_total).toString()}
h = ${BigInt(data.hash).toString()}
</pre>`;

        html += `<h3>Step 6: Warehouse Partial Signatures</h3>
<p>Each warehouse calculates sᵢ = g × r^h mod n.</p>`;
        data.warehouses.forEach(w => {
          html += `
<pre>
Warehouse: ${w.warehouse}
sᵢ = ${BigInt(w.s_i).toString()}
</pre>`;
        });

        html += `<h3>Step 7: Warehouses Compute Aggregate Signature</h3>
<p>All warehouses share sᵢ values and compute s_total = product of all sᵢ mod n.</p>`;
        data.warehouses.forEach(w => {
          html += `
<pre>
Warehouse: ${w.warehouse}
s_total = ${BigInt(w.s_total).toString()}
</pre>`;
        });

        html += `<h3>Step 8: PKG Consensus Check</h3>
<p>All warehouses send s_total to PKG. PKG checks if all match.</p>
<pre>
Consensus Result: ${data.consensus_result ? "✅ PASSED (all match)" : "❌ FAILED (mismatch found)"}
</pre>`;

        html += `<h3>Step 9: Officer Verification</h3>
<p>PKG encrypts qty; Officer decrypts & verifies signature.</p>
<pre>
PKG encrypts qty:
C = qty^e mod n → C = ${BigInt(data.encrypted_quantity).toString()}

Officer decrypts:
M = C^d mod n → M = ${BigInt(data.decrypted_quantity).toString()}

Officer verifies signature:
LHS = s^e mod n = ${BigInt(data.lhs).toString()}
RHS = product(IDs) × t_total^h mod n = ${BigInt(data.rhs).toString()}
Signature Valid: ${data.valid ? "✅ VALID" : "❌ INVALID"}
</pre>`;

        output.innerHTML = html;

      } catch (err) {
        output.innerHTML = `<p style="color:red">Error: ${err.message}</p>`;
      }
    }
  </script>
</body>
</html>
