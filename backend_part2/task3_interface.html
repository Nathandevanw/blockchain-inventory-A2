<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Task 3 - DLT Inventory Query</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 2rem; }
    label, select, button { margin-top: 1rem; display: block; }
    table { margin-top: 2rem; border-collapse: collapse; width: 100%; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    th { background-color: #f5f5f5; }
    pre { background: #f0f0f0; padding: 1rem; overflow-x: auto; }
  </style>
</head>
<body>
  <h1>Task 3 - Full DLT Simulation with PKG + Officer</h1>

  <label for="itemId">Select Item ID:</label>
  <select id="itemId">
    <option value="001">Item 001</option>
    <option value="002">Item 002</option>
    <option value="003">Item 003</option>
    <option value="004">Item 004</option>
  </select>
  <button onclick="queryItem()">Submit Query</button>

  <div id="output"></div>

  <script>
    
    window.addEventListener("load", function() {
      if (localStorage.getItem("lastOutput")) {
        document.getElementById("output").innerHTML = localStorage.getItem("lastOutput");
      }
    });

    async function queryItem() {
      const itemId = document.getElementById('itemId').value;
      const output = document.getElementById('output');
      output.innerHTML = '<p>Querying...</p>';

      try {
        const res = await fetch('http://localhost:5000/query_item', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ item_id: itemId })
        });

        const data = await res.json();
        if (data.error) {
          output.innerHTML = `<p style="color:red">${data.error}</p>`;
          return;
        }

        let html = `<h3>PKG Key Generation</h3>
        <pre>
p = ${BigInt(data.p).toString()}
q = ${BigInt(data.q).toString()}
e = ${BigInt(data.e).toString()}
n = p * q = ${BigInt(data.n).toString()}
phi(n) = (p-1)*(q-1) = ${BigInt(data.phi_n).toString()}
d = e⁻¹ mod phi(n) = ${BigInt(data.d).toString()}

PKG Public Key = (e, n) = (${BigInt(data.e).toString()}, ${BigInt(data.n).toString()})
PKG Private Key = (d, n) = (${BigInt(data.d).toString()}, ${BigInt(data.n).toString()})
        </pre>`;

        html += `<h3>Item Information</h3>
        <p><strong>Item ID:</strong> ${data.itemId}</p>
        <p><strong>Quantity:</strong> ${data.item.qty}</p>
        <p><strong>Price:</strong> $${data.item.price}</p>
        <p><strong>Location:</strong> ${data.item.location}</p>`;

        html += `<h3>Warehouse Calculations</h3>`;
        data.warehouses.forEach(w => {
          html += `
<pre>
Warehouse: ${w.warehouse}
ID: ${BigInt(w.ID).toString()}
Random r: ${BigInt(w.random).toString()}

PKG signed g = ID^d mod n
g = ${BigInt(w.g).toString()}

Warehouse calculates t = r^e mod n
t = ${BigInt(w.t_i).toString()}
</pre>`;
        });

        const t_total = BigInt(data.t_total);
        html += `<pre>
All warehouses multiply t values to get t_total:
t_total = ${t_total.toString()}
        </pre>`;
        html += `<h3>Partial Signatures</h3>`;
        data.warehouses.forEach(w => {
          html += `
<pre>
Warehouse: ${w.warehouse}
Each warehouse calculates hash:
h = MD5(t_total || quantity)
h = ${BigInt(data.hash).toString()}

Warehouse partial signature:
s_i = g * r^h mod n
s_i = ${BigInt(w.s_i).toString()}
</pre>`;
        });

        html += `<h3>Each Warehouse Calculates s_total</h3>`;
        data.warehouses.forEach(w => {
          html += `
<pre>
Warehouse: ${w.warehouse}
s_total = s1 * s2 * s3 * s4 mod n
s_total = ${BigInt(w.s_total).toString()}
</pre>`;
        });

        html += `<h3>PKG Final Signature Check</h3>
<pre>
PKG multiplies all s_i to get its s:
PKG s = ${BigInt(data.signature).toString()}

Consensus Result: ${data.consensus_result ? " All warehouses matched PKG s → Consensus PASSED" : " Mismatch detected → Consensus FAILED"}
</pre>`;
        html += `<h3>PKG Encrypts and Officer Decrypts</h3>
<pre>
PKG encrypts quantity for Officer:
C = M^e mod n
Encrypted Quantity = ${BigInt(data.encrypted_quantity).toString()}

Officer decrypts:
M = C^d mod n
Decrypted Quantity = ${BigInt(data.decrypted_quantity).toString()}
</pre>`;

        html += `<h3>Officer Final Signature Verification</h3>
<pre>
Officer calculates:
LHS = s^e mod n = ${BigInt(data.lhs).toString()}
RHS = (ID_product * t_total^h) mod n = ${BigInt(data.rhs).toString()}

Signature Verification Result: ${data.valid ? "VALID (signature matches)" : " INVALID (signature does not match)"}
</pre>`;

        output.innerHTML = html;

      } catch (err) {
        output.innerHTML = `<p style="color:red">Error: ${err.message}</p>`;
      }
    }
  </script>
</body>
</html>
