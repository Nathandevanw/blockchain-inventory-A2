<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>DLT Inventory Query - Task 3</title>
  <style>
    body { font-family: 'Segoe UI', sans-serif; padding: 2rem; background: #f8f8f8; color: #333; }
    h2, h3 { color: #222; }
    label, select, button { display: block; margin-top: 1rem; font-size: 1rem; }
    table { margin-top: 1.5rem; border-collapse: collapse; width: 100%; font-size: 0.95rem; }
    th, td { padding: 8px; border: 1px solid #ccc; text-align: center; }
    th { background-color: #f0f0f0; }
    pre { background: #eee; padding: 1rem; border-radius: 6px; white-space: pre-wrap; font-size: 0.85rem; }
  </style>
</head>
<body>
  <h2>Task 3 - Secure DLT Inventory Query System</h2>

  <label for="itemId">Select Item ID:</label>
  <select id="itemId">
    <option value="001">Item 001</option>
    <option value="002">Item 002</option>
    <option value="003">Item 003</option>
    <option value="004">Item 004</option>
  </select>
  <button id="queryButton" type="button">Submit Query</button>

  <div id="output" style="margin-top:2rem;"></div>

  <script>
    async function queryItem(event) {
      event.preventDefault();
      const itemId = document.getElementById('itemId').value;
      const output = document.getElementById('output');
      output.innerHTML = 'Please wait...';

      try {
        const res = await fetch('http://localhost:5000/query_item', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ item_id: itemId })
        });
        const data = await res.json();
        if (data.error) { output.innerHTML = `<p style="color:red">${data.error}</p>`; return; }

        let html = `<h3>Step 1: PKG key generation (p, q, n, phi, e, d)</h3>
<pre>
p = ${BigInt(data.pkg_keys.p).toString()}
q = ${BigInt(data.pkg_keys.q).toString()}
n = ${BigInt(data.pkg_keys.n).toString()}
phi(n) = ${BigInt(data.pkg_keys.phi_n).toString()}
e = ${BigInt(data.pkg_keys.e).toString()}
d = ${BigInt(data.pkg_keys.d).toString()}
PKG Public Key = (e,n) = (${BigInt(data.pkg_keys.e).toString()}, ${BigInt(data.pkg_keys.n).toString()})
PKG Private Key = (d,n) = (${BigInt(data.pkg_keys.d).toString()}, ${BigInt(data.pkg_keys.n).toString()})
</pre>`;

        html += `<h3>Step 2: Warehouses send IDs to PKG → PKG stores g only</h3>`;
        data.warehouses.forEach(w => {
          html += `
<pre>
Warehouse: ${w.warehouse}
ID = ${w.ID}
Random r = ${w.random}
g = ID^d mod n = ${BigInt(w.g).toString()}
</pre>`;
        });

        html += `<h3>Step 3: Warehouses calculate tᵢ and share</h3>`;
        data.warehouses.forEach(w => {
          html += `
<pre>
Warehouse: ${w.warehouse}
tᵢ = r^e mod n = ${BigInt(w.t_i).toString()}
</pre>`;
        });

        html += `<h3>Step 4: Warehouses calculate sᵢ partial signatures</h3>`;
        data.warehouses.forEach(w => {
          html += `
<pre>
Warehouse: ${w.warehouse}
sᵢ = g × r^h mod n = ${BigInt(w.s_i).toString()}
</pre>`;
        });

        html += `<h3>Step 5: All warehouses share sᵢ → each calculate s_total</h3>`;
        data.warehouses.forEach(w => {
          html += `
<pre>
Warehouse: ${w.warehouse}
s_total = product of sᵢ mod n = ${BigInt(w.s_total).toString()}
</pre>`;
        });

        html += `<h3>Step 6: All warehouses send s_total to PKG → PKG checks match</h3>
<pre>
Consensus Result: ${data.consensus ? "✅ PASSED (all match)" : "❌ FAILED (mismatch found)"}
</pre>`;

  html += `<h3>Step 7: PKG encrypts m using Officer’s public key → Officer decrypts and verifies signature</h3>
<pre>
Item ID: ${data.itemId}
Quantity: ${data.item.qty}
Price: ${data.item.price}
Location: ${data.item.location}

Officer Public Key:
(e_po, n_po) = (${BigInt(data.po_keys.e).toString()}, ${BigInt(data.po_keys.n).toString()})
Officer Private Key:
(d_po, n_po) = (${BigInt(data.po_keys.d).toString()}, ${BigInt(data.po_keys.n).toString()})

PKG encrypts quantity for Officer:
C = qty^e_po mod n_po → C = ${BigInt(data.encrypted_quantity).toString()}

Officer decrypts:
M = C^d_po mod n_po → M = ${BigInt(data.decrypted_quantity).toString()}

Officer verifies signature:
LHS = s^e mod n = ${BigInt(data.lhs).toString()}
RHS = product(IDs) × t_total^h mod n = ${BigInt(data.rhs).toString()}
Signature Valid: ${data.valid ? "✅ VALID" : "❌ INVALID"}
</pre>`;

        output.innerHTML = html;

      } catch (err) {
        output.innerHTML = `<p style="color:red">Error: ${err.message}</p>`;
      }
    }

    document.getElementById('queryButton').addEventListener('click', queryItem);
  </script>
</body>
</html>
